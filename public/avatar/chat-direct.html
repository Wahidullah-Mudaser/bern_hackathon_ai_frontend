<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Avatar Chat Session - Claire & George</title>
    <style>
        /* Embedded styles for the direct chat interface */
        body {
            background: linear-gradient(135deg, #e2f1f8ff 0%, #1e9bcf 50%, #b4c7e7 100%);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
        }
        
        /* Loading Screen Styles */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #e2f1f8ff 0%, #1e9bcf 50%, #b4c7e7 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s ease-out;
        }
        
        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .loading-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 500px;
            width: 90%;
        }
        
        .loading-logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #16608a 0%, #1e9bcf 100%);
            border-radius: 50%;
            margin: 0 auto 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: white;
            animation: pulse 2s infinite;
        }
        
        .loading-title {
            font-size: 24px;
            font-weight: 600;
            color: #16608a;
            margin-bottom: 10px;
        }
        
        .loading-subtitle {
            font-size: 16px;
            color: #666;
            margin-bottom: 30px;
        }
        
        .progress-container {
            background: #f0f0f0;
            border-radius: 10px;
            height: 8px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #16608a 0%, #1e9bcf 100%);
            border-radius: 10px;
            width: 0%;
            transition: width 0.3s ease;
            animation: shimmer 2s infinite;
        }
        
        .progress-text {
            font-size: 14px;
            color: #666;
            margin-top: 10px;
        }
        
        .loading-steps {
            text-align: left;
            margin-top: 20px;
        }
        
        .loading-step {
            display: flex;
            align-items: center;
            margin: 10px 0;
            opacity: 0.5;
            transition: opacity 0.3s ease;
        }
        
        .loading-step.active {
            opacity: 1;
        }
        
        .loading-step.completed {
            opacity: 0.8;
        }
        
        .step-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
        }
        
        .step-icon.pending {
            background: #ccc;
        }
        
        .step-icon.active {
            background: #16608a;
            animation: pulse 1s infinite;
        }
        
        .step-icon.completed {
            background: #4ade80;
        }
        
        .step-text {
            font-size: 14px;
            color: #333;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes shimmer {
            0% { background-position: -200px 0; }
            100% { background-position: 200px 0; }
        }
        
        /* Main Chat Interface Styles */
        .main-interface {
            display: none;
            height: 100vh;
            flex-direction: column;
        }
        
        .main-interface.visible {
            display: flex;
        }
        
        .header {
            background: rgba(22, 96, 138, 0.9);
            color: white;
            padding: 15px 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            margin: 0;
            font-size: 1.5em;
            font-weight: 300;
        }
        
        .main-container {
            display: flex;
            height: calc(100vh - 70px);
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border-radius: 20px;
            margin-top: 20px;
            overflow: hidden;
        }
        
        .chat-sidebar {
            flex: 1;
            background: linear-gradient(135deg, #16608a 0%, #1e9bcf 100%);
            display: flex;
            flex-direction: column;
            min-width: 400px;
        }
        
        .avatar-main {
            flex: 2;
            background: #f5f5f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 20px;
        }
        
        #videoContainer {
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        #videoPlayer {
            width: 100%;
            max-width: 960px;
            height: auto;
            display: block;
        }
        
        #remoteVideo {
            width: 100%;
            max-width: 960px;
        }
        
        #remoteVideo video {
            width: 100%;
            height: auto;
            border-radius: 12px;
        }
        
        #remoteVideo audio {
            display: none;
        }
        
        .chat-header {
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-title {
            color: white;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chat-controls {
            display: flex;
            gap: 10px;
        }
        
        .control-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 8px;
            padding: 8px;
            cursor: pointer;
            transition: background 0.3s ease;
            color: white;
        }
        
        .control-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
        }
        
        .message {
            background: rgba(255, 255, 255, 0.1);
            padding: 12px 16px;
            margin: 12px 0;
            border-radius: 12px;
            color: white;
            max-width: 85%;
            word-wrap: break-word;
        }
        
        .message.user {
            background: rgba(255, 255, 255, 0.2);
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        
        .message.avatar {
            background: rgba(255, 255, 255, 0.15);
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }
        
        .message-time {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 4px;
        }
        
        .chat-input {
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
        }
        
        .input-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .input-container input {
            flex: 1;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 12px;
            padding: 12px 16px;
            font-size: 14px;
            outline: none;
        }
        
        .input-container input:focus {
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3);
        }
        
        .send-btn {
            background: linear-gradient(135deg, #16608a 0%, #1e9bcf 100%);
            border: none;
            border-radius: 12px;
            padding: 12px 20px;
            color: white;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .send-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(22, 96, 138, 0.4);
        }
        
        .send-btn:disabled {
            background: #939393;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .avatar-placeholder {
            text-align: center;
            color: #666;
            font-size: 16px;
        }
        
        .avatar-placeholder svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .typing-indicator {
            display: none;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: white;
            font-style: italic;
            margin: 12px 0;
            max-width: 85%;
        }
        
        .suggestion-chips {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }
        
        .suggestion-chip {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 16px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
        }
        
        .suggestion-chip:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4ade80;
            animation: pulse 2s infinite;
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
                height: calc(100vh - 90px);
                margin: 10px;
                border-radius: 15px;
            }
            
            .chat-sidebar {
                flex: 1;
                min-width: auto;
            }
            
            .avatar-main {
                flex: 1;
                min-height: 200px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-container">
            <div class="loading-logo">🎯</div>
            <div class="loading-title">Initializing Avatar Session</div>
            <div class="loading-subtitle">Preparing your AI assistant...</div>
            
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="progress-text" id="progressText">0%</div>
            
            <div class="loading-steps">
                <div class="loading-step" id="step1">
                    <div class="step-icon pending">1</div>
                    <div class="step-text">Connecting to Azure Speech Services</div>
                </div>
                <div class="loading-step" id="step2">
                    <div class="step-icon pending">2</div>
                    <div class="step-text">Initializing OpenAI Integration</div>
                </div>
                <div class="loading-step" id="step3">
                    <div class="step-icon pending">3</div>
                    <div class="step-text">Loading Avatar Character (Lisa)</div>
                </div>
                <div class="loading-step" id="step4">
                    <div class="step-icon pending">4</div>
                    <div class="step-text">Configuring Voice & Language Settings</div>
                </div>
                <div class="loading-step" id="step5">
                    <div class="step-icon pending">5</div>
                    <div class="step-text">Establishing Chat Session</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Chat Interface -->
    <div class="main-interface" id="mainInterface">
        <div class="header">
            <h1>🎯 Avatar Chat Session - Claire & George</h1>
        </div>

        <div class="main-container">
            <div class="chat-sidebar">
                <div class="chat-header">
                    <div class="chat-title">
                        <span>💬</span>
                        <span>Conversation</span>
                    </div>
                    <div class="chat-controls">
                        <button class="control-btn" onclick="clearChatHistory()" title="Clear Chat">
                            🗑️
                        </button>
                        <button class="control-btn" onclick="toggleFullscreen()" title="Fullscreen">
                            ⛶
                        </button>
                    </div>
                </div>
                
                <div class="chat-messages" id="chatHistory">
                    <div class="message avatar">
                        <div>Hello! I'm your AI assistant. How can I help you today?</div>
                        <div class="message-time">Just now</div>
                    </div>
                </div>
                
                <div class="typing-indicator" id="typingIndicator">
                    Avatar is typing...
                </div>
                
                <div class="chat-input">
                    <div class="input-container">
                        <input type="text" id="userMessage" placeholder="Type your message..." />
                        <button class="send-btn" onclick="sendMessage()" id="sendBtn">Send</button>
                    </div>
                    
                    <div class="suggestion-chips">
                        <span class="suggestion-chip" onclick="insertSuggestion('Hello, how are you?')">👋 Hello</span>
                        <span class="suggestion-chip" onclick="insertSuggestion('Can you help me with...')">❓ Ask for help</span>
                        <span class="suggestion-chip" onclick="insertSuggestion('Tell me about...')">💡 Learn more</span>
                        <span class="suggestion-chip" onclick="insertSuggestion('Thank you!')">🙏 Thank you</span>
                    </div>
                    
                    <div class="status-indicator">
                        <div class="status-dot"></div>
                        <span>Connected and ready</span>
                    </div>
                </div>
            </div>
            
                    <div class="avatar-main">
            <div id="videoContainer" style="position: relative; max-width: 960px; width: 100%;">
                <div id="overlayArea" style="position: absolute;">
                    <div id="chatHistory" style="
                        border: none;
                        resize: none;
                        background-color: transparent;
                        overflow: hidden;" contentEditable="true" hidden></div>
                </div>
                <div id="localVideo" hidden>
                    <video src="video/lisa-casual-sitting-idle.mp4" autoplay loop muted></video>
                </div>
                <div id="remoteVideo" style="width: 0.1px;"></div>
                <div id="subtitles" style="
                    width: 100%;
                    text-align: center;
                    color: white; 
                    text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
                    position: absolute; 
                    bottom: 5%; 
                    z-index: 999;" hidden></div>
            </div>
            
            <!-- Microphone Controls -->
            <div style="margin-top: 20px; text-align: center;">
                <button id="microphone" onclick="window.microphone()" disabled style="
                    background: linear-gradient(135deg, #16608a 0%, #1e9bcf 100%);
                    border: none;
                    border-radius: 12px;
                    padding: 12px 24px;
                    color: white;
                    cursor: pointer;
                    font-weight: 500;
                    margin: 0 10px;
                    transition: all 0.3s ease;">
                    🎤 Start Microphone
                </button>
                <button id="stopSpeaking" onclick="stopSpeaking()" disabled style="
                    background: #e53e3e;
                    border: none;
                    border-radius: 12px;
                    padding: 12px 24px;
                    color: white;
                    cursor: pointer;
                    font-weight: 500;
                    margin: 0 10px;
                    transition: all 0.3s ease;">
                    🔇 Stop Speaking
                </button>
            </div>
        </div>
        </div>
    </div>

    <script src="https://aka.ms/csspeech/jsbrowserpackageraw"></script>
    <script>
        // Global objects for avatar functionality
        var speechRecognizer
        var avatarSynthesizer
        var peerConnection
        var peerConnectionDataChannel
        var messages = []
        var messageInitiated = false
        var dataSources = []
        var sentenceLevelPunctuations = [ '.', '?', '!', ':', ';', '。', '？', '！', '：', '；' ]
        var enableDisplayTextAlignmentWithSpeech = true
        var enableQuickReply = false
        var quickReplies = [ 'Let me take a look.', 'Let me check.', 'One moment, please.' ]
        var byodDocRegex = new RegExp(/\[doc(\d+)\]/g)
        var isSpeaking = false
        var isReconnecting = false
        var speakingText = ""
        var spokenTextQueue = []
        var repeatSpeakingSentenceAfterReconnection = true
        var sessionActive = false
        var userClosedSession = false
        var lastInteractionTime = new Date()
        var lastSpeakTime
        var imgUrl = ""

        // Configuration values (pre-configured for low vision users)
        const config = {
            region: 'westeurope',
            apiKey: '9l3CmXiyadFyKHGXz1aWji76DwiBU2472pHP1Wo8JQvgm7UsdwMCJQQJ99BHAC5RqLJXJ3w3AAAYACOGB8xB',
            openAIEndpoint: 'https://psiopenai1.openai.azure.com/',
            openAIApiKey: 'BGJdTRVRg4C6Ij3fNpSM86neFtAuyNhqYmpBzhQlCR8PkkO4U4NBJQQJ99BHAC5RqLJXJ3w3AAABACOGF0f3',
            openAIDeploymentName: 'gpt-4o',
            ttsVoice: 'en-US-AvaMultilingualNeural',
            sttLocales: 'en-US,de-DE,es-ES,fr-FR,it-IT,ja-JP,ko-KR,zh-CN',
            avatarCharacter: 'lisa',
            avatarStyle: 'casual-sitting'
        };

        let messageCount = 0;

        // Loading simulation functions
        function updateProgress(percentage, text) {
            document.getElementById('progressBar').style.width = percentage + '%';
            document.getElementById('progressText').textContent = percentage + '%';
        }

        function updateStep(stepNumber, status) {
            const step = document.getElementById('step' + stepNumber);
            const icon = step.querySelector('.step-icon');
            
            // Remove all classes
            step.className = 'loading-step';
            icon.className = 'step-icon';
            
            // Add appropriate class
            if (status === 'active') {
                step.classList.add('active');
                icon.classList.add('active');
            } else if (status === 'completed') {
                step.classList.add('completed');
                icon.classList.add('completed');
                icon.textContent = '✓';
            }
        }

        function simulateLoading() {
            let progress = 0;
            const totalSteps = 5;
            const stepDuration = 800; // milliseconds per step
            
            const steps = [
                { name: 'Connecting to Azure Speech Services', duration: 1200 },
                { name: 'Initializing OpenAI Integration', duration: 1000 },
                { name: 'Loading Avatar Character (Lisa)', duration: 800 },
                { name: 'Configuring Voice & Language Settings', duration: 900 },
                { name: 'Establishing Chat Session', duration: 600 }
            ];

            steps.forEach((step, index) => {
                setTimeout(() => {
                    // Activate current step
                    updateStep(index + 1, 'active');
                    
                    // Simulate progress for this step
                    const stepProgress = (index + 1) * (100 / totalSteps);
                    updateProgress(Math.round(stepProgress), step.name);
                    
                    // Complete step after duration
                    setTimeout(() => {
                        updateStep(index + 1, 'completed');
                        
                        // If this is the last step, show the chat interface and start avatar
                        if (index === steps.length - 1) {
                            setTimeout(() => {
                                document.getElementById('loadingScreen').classList.add('hidden');
                                document.getElementById('mainInterface').classList.add('visible');
                                
                                // Start the actual avatar session
                                setTimeout(() => {
                                    connectAvatar();
                                }, 500);
                            }, 500);
                        }
                    }, step.duration);
                }, index * stepDuration);
            });
        }

        // Connect to avatar service
        function connectAvatar() {
            const cogSvcRegion = config.region;
            const cogSvcSubKey = config.apiKey;
            
            if (cogSvcSubKey === '') {
                alert('Please fill in the API key of your speech resource.');
                return;
            }

            let speechSynthesisConfig = SpeechSDK.SpeechConfig.fromSubscription(cogSvcSubKey, cogSvcRegion);
            speechSynthesisConfig.endpointId = '';

            const talkingAvatarCharacter = config.avatarCharacter;
            const talkingAvatarStyle = config.avatarStyle;
            const avatarConfig = new SpeechSDK.AvatarConfig(talkingAvatarCharacter, talkingAvatarStyle);
            avatarConfig.customized = false;
            avatarConfig.useBuiltInVoice = false;
            avatarSynthesizer = new SpeechSDK.AvatarSynthesizer(speechSynthesisConfig, avatarConfig);
            
            avatarSynthesizer.avatarEventReceived = function (s, e) {
                var offsetMessage = ", offset from session start: " + e.offset / 10000 + "ms.";
                if (e.offset === 0) {
                    offsetMessage = "";
                }
                console.log("Event received: " + e.description + offsetMessage);
            };

            let speechRecognitionConfig = SpeechSDK.SpeechConfig.fromEndpoint(new URL(`wss://${cogSvcRegion}.stt.speech.microsoft.com/speech/universal/v2`), cogSvcSubKey);
            speechRecognitionConfig.setProperty(SpeechSDK.PropertyId.SpeechServiceConnection_LanguageIdMode, "Continuous");
            var sttLocales = config.sttLocales.split(',');
            var autoDetectSourceLanguageConfig = SpeechSDK.AutoDetectSourceLanguageConfig.fromLanguages(sttLocales);
            speechRecognizer = SpeechSDK.SpeechRecognizer.FromConfig(speechRecognitionConfig, autoDetectSourceLanguageConfig, SpeechSDK.AudioConfig.fromDefaultMicrophoneInput());

            // Only initialize messages once
            if (!messageInitiated) {
                initMessages();
                messageInitiated = true;
            }

            const xhr = new XMLHttpRequest();
            xhr.open("GET", `https://${cogSvcRegion}.tts.speech.microsoft.com/cognitiveservices/avatar/relay/token/v1`);
            xhr.setRequestHeader("Ocp-Apim-Subscription-Key", cogSvcSubKey);
            xhr.addEventListener("readystatechange", function() {
                if (this.readyState === 4) {
                    const responseData = JSON.parse(this.responseText);
                    const iceServerUrl = responseData.Urls[0];
                    const iceServerUsername = responseData.Username;
                    const iceServerCredential = responseData.Password;
                    setupWebRTC(iceServerUrl, iceServerUsername, iceServerCredential);
                }
            });
            xhr.send();
        }

        // Setup WebRTC
        function setupWebRTC(iceServerUrl, iceServerUsername, iceServerCredential) {
            // Create WebRTC peer connection
            peerConnection = new RTCPeerConnection({
                iceServers: [{
                    urls: [iceServerUrl],
                    username: iceServerUsername,
                    credential: iceServerCredential
                }]
            });

            // Fetch WebRTC video stream and mount it to an HTML video element
            peerConnection.ontrack = function (event) {
                if (event.track.kind === 'audio') {
                    let audioElement = document.createElement('audio');
                    audioElement.id = 'audioPlayer';
                    audioElement.srcObject = event.streams[0];
                    audioElement.autoplay = false;
                    audioElement.addEventListener('loadeddata', () => {
                        audioElement.play();
                    });

                    audioElement.onplaying = () => {
                        console.log(`WebRTC ${event.track.kind} channel connected.`);
                    };

                    // Clean up existing audio element if there is any
                    remoteVideoDiv = document.getElementById('remoteVideo');
                    for (var i = 0; i < remoteVideoDiv.childNodes.length; i++) {
                        if (remoteVideoDiv.childNodes[i].localName === event.track.kind) {
                            remoteVideoDiv.removeChild(remoteVideoDiv.childNodes[i]);
                        }
                    }

                    // Append the new audio element
                    document.getElementById('remoteVideo').appendChild(audioElement);
                }

                if (event.track.kind === 'video') {
                    let videoElement = document.createElement('video');
                    videoElement.id = 'videoPlayer';
                    videoElement.srcObject = event.streams[0];
                    videoElement.autoplay = false;
                    videoElement.addEventListener('loadeddata', () => {
                        videoElement.play();
                    });

                    videoElement.playsInline = true;
                    videoElement.style.width = '0.5px';
                    document.getElementById('remoteVideo').appendChild(videoElement);

                    videoElement.onplaying = () => {
                        // Clean up existing video element if there is any
                        remoteVideoDiv = document.getElementById('remoteVideo');
                        for (var i = 0; i < remoteVideoDiv.childNodes.length; i++) {
                            if (remoteVideoDiv.childNodes[i].localName === event.track.kind) {
                                remoteVideoDiv.removeChild(remoteVideoDiv.childNodes[i]);
                            }
                        }

                        // Append the new video element
                        videoElement.style.width = '960px';
                        document.getElementById('remoteVideo').appendChild(videoElement);

                        console.log(`WebRTC ${event.track.kind} channel connected.`);
                        document.getElementById('microphone').disabled = false;
                        document.getElementById('remoteVideo').style.width = '960px';
                        document.getElementById('chatHistory').hidden = false;

                        isReconnecting = false;
                        setTimeout(() => { sessionActive = true }, 5000); // Set session active after 5 seconds
                        
                        // Auto-start microphone for low vision users
                        setTimeout(() => {
                            window.microphone();
                        }, 1000);
                    };
                }
            };
            
            // Listen to data channel, to get the event from the server
            peerConnection.addEventListener("datachannel", event => {
                peerConnectionDataChannel = event.channel;
                peerConnectionDataChannel.onmessage = e => {
                    let subtitles = document.getElementById('subtitles');
                    const webRTCEvent = JSON.parse(e.data);
                    if (webRTCEvent.event.eventType === 'EVENT_TYPE_TURN_START') {
                        subtitles.hidden = false;
                        subtitles.innerHTML = speakingText;
                    } else if (webRTCEvent.event.eventType === 'EVENT_TYPE_SESSION_END' || webRTCEvent.event.eventType === 'EVENT_TYPE_SWITCH_TO_IDLE') {
                        subtitles.hidden = true;
                    }
                    console.log("[" + (new Date()).toISOString() + "] WebRTC event received: " + e.data);
                };
            });

            // This is a workaround to make sure the data channel listening is working by creating a data channel from the client side
            c = peerConnection.createDataChannel("eventChannel");

            // Make necessary update to the web page when the connection state changes
            peerConnection.oniceconnectionstatechange = e => {
                console.log("WebRTC status: " + peerConnection.iceConnectionState);
            };

            // Offer to receive 1 audio, and 1 video track
            peerConnection.addTransceiver('video', { direction: 'sendrecv' });
            peerConnection.addTransceiver('audio', { direction: 'sendrecv' });

            // start avatar, establish WebRTC connection
            avatarSynthesizer.startAvatarAsync(peerConnection).then((r) => {
                if (r.reason === SpeechSDK.ResultReason.SynthesizingAudioCompleted) {
                    console.log("[" + (new Date()).toISOString() + "] Avatar started. Result ID: " + r.resultId);
                } else {
                    console.log("[" + (new Date()).toISOString() + "] Unable to start avatar. Result ID: " + r.resultId);
                    if (r.reason === SpeechSDK.ResultReason.Canceled) {
                        let cancellationDetails = SpeechSDK.CancellationDetails.fromResult(r);
                        if (cancellationDetails.reason === SpeechSDK.CancellationReason.Error) {
                            console.log(cancellationDetails.errorDetails);
                        };
                        console.log("Unable to start avatar: " + cancellationDetails.errorDetails);
                    }
                }
            }).catch(
                (error) => {
                    console.log("[" + (new Date()).toISOString() + "] Avatar failed to start. Error: " + error);
                }
            );
        }

        // Initialize messages
        function initMessages() {
            messages = [];
            let systemPrompt = `You are an AI assistant for Claire & George, an accessible tourism service in Switzerland. You help users with disabilities find suitable travel options. Be helpful, friendly, and knowledgeable about accessible travel in Switzerland.`;
            let systemMessage = {
                role: 'system',
                content: systemPrompt
            };
            messages.push(systemMessage);
        }

        // Speak the given text
        function speak(text, endingSilenceMs = 0) {
            if (isSpeaking) {
                spokenTextQueue.push(text);
                return;
            }
            speakNext(text, endingSilenceMs);
        }

        function speakNext(text, endingSilenceMs = 0, skipUpdatingChatHistory = false) {
            let ttsVoice = config.ttsVoice;
            let ssml = `<speak version='1.0' xmlns='http://www.w3.org/2001/10/synthesis' xmlns:mstts='http://www.w3.org/2001/mstts' xml:lang='en-US'><voice name='${ttsVoice}'><mstts:leadingsilence-exact value='0'/>${htmlEncode(text)}</voice></speak>`;
            if (endingSilenceMs > 0) {
                ssml = `<speak version='1.0' xmlns='http://www.w3.org/2001/10/synthesis' xmlns:mstts='http://www.w3.org/2001/mstts' xml:lang='en-US'><voice name='${ttsVoice}'><mstts:leadingsilence-exact value='0'/>${htmlEncode(text)}<break time='${endingSilenceMs}ms' /></voice></speak>`;
            }

            if (enableDisplayTextAlignmentWithSpeech && !skipUpdatingChatHistory) {
                let chatHistoryTextArea = document.getElementById('chatHistory');
                chatHistoryTextArea.innerHTML += text.replace(/\n/g, '<br/>');
                chatHistoryTextArea.scrollTop = chatHistoryTextArea.scrollHeight;
            }

            lastSpeakTime = new Date();
            isSpeaking = true;
            speakingText = text;
            document.getElementById('stopSpeaking').disabled = false;
            avatarSynthesizer.speakSsmlAsync(ssml).then(
                (result) => {
                    if (result.reason === SpeechSDK.ResultReason.SynthesizingAudioCompleted) {
                        console.log(`Speech synthesized to speaker for text [ ${text} ]. Result ID: ${result.resultId}`);
                        lastSpeakTime = new Date();
                    } else {
                        console.log(`Error occurred while speaking the SSML. Result ID: ${result.resultId}`);
                    }

                    speakingText = '';

                    if (spokenTextQueue.length > 0) {
                        speakNext(spokenTextQueue.shift());
                    } else {
                        isSpeaking = false;
                        document.getElementById('stopSpeaking').disabled = true;
                    }
                }).catch(
                    (error) => {
                        console.log(`Error occurred while speaking the SSML: [ ${error} ]`);
                        speakingText = '';
                        if (spokenTextQueue.length > 0) {
                            speakNext(spokenTextQueue.shift());
                        } else {
                            isSpeaking = false;
                            document.getElementById('stopSpeaking').disabled = true;
                        }
                    }
                );
        }

        function stopSpeaking() {
            lastInteractionTime = new Date();
            spokenTextQueue = [];
            avatarSynthesizer.stopSpeakingAsync().then(
                () => {
                    isSpeaking = false;
                    document.getElementById('stopSpeaking').disabled = true;
                    console.log("[" + (new Date()).toISOString() + "] Stop speaking request sent.");
                }
            ).catch(
                (error) => {
                    console.log("Error occurred while stopping speaking: " + error);
                }
            );
        }

        // Do HTML encoding on given text
        function htmlEncode(text) {
            const entityMap = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;',
                '/': '&#x2F;'
            };
            return String(text).replace(/[&<>"'\/]/g, (match) => entityMap[match]);
        }

        // Handle user query with OpenAI
        function handleUserQuery(userQuery, userQueryHTML, imgUrlPath) {
            lastInteractionTime = new Date();
            let contentMessage = userQuery;
            if (imgUrlPath.trim()) {
                contentMessage = [  
                    { 
                        "type": "text", 
                        "text": userQuery 
                    },
                    { 
                        "type": "image_url",
                        "image_url": {
                            "url": imgUrlPath
                        }
                    }
                ];
            }
            let chatMessage = {
                role: 'user',
                content: contentMessage
            };

            messages.push(chatMessage);
            let chatHistoryTextArea = document.getElementById('chatHistory');
            if (chatHistoryTextArea.innerHTML !== '' && !chatHistoryTextArea.innerHTML.endsWith('\n\n')) {
                chatHistoryTextArea.innerHTML += '\n\n';
            }

            chatHistoryTextArea.innerHTML += imgUrlPath.trim() ? "<br/><br/>User: " + userQueryHTML : "<br/><br/>User: " + userQuery + "<br/>";
            chatHistoryTextArea.scrollTop = chatHistoryTextArea.scrollHeight;

            // Stop previous speaking if there is any
            if (isSpeaking) {
                stopSpeaking();
            }

            const azureOpenAIEndpoint = config.openAIEndpoint;
            const azureOpenAIApiKey = config.openAIApiKey;
            const azureOpenAIDeploymentName = config.openAIDeploymentName;

            let url = "{AOAIEndpoint}/openai/deployments/{AOAIDeployment}/chat/completions?api-version=2023-06-01-preview".replace("{AOAIEndpoint}", azureOpenAIEndpoint).replace("{AOAIDeployment}", azureOpenAIDeploymentName);
            let body = JSON.stringify({
                messages: messages,
                stream: true
            });

            let assistantReply = '';
            let spokenSentence = '';
            let displaySentence = '';

            fetch(url, {
                method: 'POST',
                headers: {
                    'api-key': azureOpenAIApiKey,
                    'Content-Type': 'application/json'
                },
                body: body
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Chat API response status: ${response.status} ${response.statusText}`);
                }

                let chatHistoryTextArea = document.getElementById('chatHistory');
                chatHistoryTextArea.innerHTML += imgUrlPath.trim() ? 'Assistant: ':'<br/>Assistant: ';

                const reader = response.body.getReader();

                // Function to recursively read chunks from the stream
                function read(previousChunkString = '') {
                    return reader.read().then(({ value, done }) => {
                        // Check if there is still data to read
                        if (done) {
                            // Stream complete
                            return;
                        }

                        // Process the chunk of data (value)
                        let chunkString = new TextDecoder().decode(value, { stream: true });
                        if (previousChunkString !== '') {
                            // Concatenate the previous chunk string in case it is incomplete
                            chunkString = previousChunkString + chunkString;
                        }

                        if (!chunkString.endsWith('}\n\n') && !chunkString.endsWith('[DONE]\n\n')) {
                            // This is a incomplete chunk, read the next chunk
                            return read(chunkString);
                        }

                        chunkString.split('\n\n').forEach((line) => {
                            try {
                                if (line.startsWith('data:') && !line.endsWith('[DONE]')) {
                                    const responseJson = JSON.parse(line.substring(5).trim());
                                    let responseToken = responseJson.choices[0].delta.content;

                                    if (responseToken !== undefined && responseToken !== null) {
                                        assistantReply += responseToken; // build up the assistant message
                                        displaySentence += responseToken; // build up the display sentence

                                        if (responseToken === '\n' || responseToken === '\n\n') {
                                            spokenSentence += responseToken;
                                            speak(spokenSentence);
                                            spokenSentence = '';
                                        } else {
                                            spokenSentence += responseToken; // build up the spoken sentence

                                            responseToken = responseToken.replace(/\n/g, '');
                                            if (responseToken.length === 1 || responseToken.length === 2) {
                                                for (let i = 0; i < sentenceLevelPunctuations.length; ++i) {
                                                    let sentenceLevelPunctuation = sentenceLevelPunctuations[i];
                                                    if (responseToken.startsWith(sentenceLevelPunctuation)) {
                                                        speak(spokenSentence);
                                                        spokenSentence = '';
                                                        break;
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            } catch (error) {
                                console.log(`Error occurred while parsing the response: ${error}`);
                                console.log(chunkString);
                            }
                        });

                        if (!enableDisplayTextAlignmentWithSpeech) {
                            chatHistoryTextArea.innerHTML += displaySentence.replace(/\n/g, '<br/>');
                            chatHistoryTextArea.scrollTop = chatHistoryTextArea.scrollHeight;
                            displaySentence = '';
                        }

                        // Continue reading the next chunk
                        return read();
                    });
                }

                // Start reading the stream
                return read();
            })
            .then(() => {
                if (spokenSentence !== '') {
                    speak(spokenSentence);
                    spokenSentence = '';
                }

                let assistantMessage = {
                    role: 'assistant',
                    content: assistantReply
                };

                messages.push(assistantMessage);
            });
        }

        // Microphone functionality
        window.microphone = () => {
            lastInteractionTime = new Date();
            if (document.getElementById('microphone').innerHTML === 'Stop Microphone') {
                // Stop microphone
                document.getElementById('microphone').disabled = true;
                speechRecognizer.stopContinuousRecognitionAsync(
                    () => {
                        document.getElementById('microphone').innerHTML = '🎤 Start Microphone';
                        document.getElementById('microphone').disabled = false;
                    }, (err) => {
                        console.log("Failed to stop continuous recognition:", err);
                        document.getElementById('microphone').disabled = false;
                    });
                return;
            }

            document.getElementById('audioPlayer').play();
            document.getElementById('microphone').disabled = true;
            
            speechRecognizer.recognized = async (s, e) => {
                if (e.result.reason === SpeechSDK.ResultReason.RecognizedSpeech) {
                    let userQuery = e.result.text.trim();
                    if (userQuery === '') {
                        return;
                    }

                    // Auto stop microphone when a phrase is recognized
                    document.getElementById('microphone').disabled = true;
                    speechRecognizer.stopContinuousRecognitionAsync(
                        () => {
                            document.getElementById('microphone').innerHTML = '🎤 Start Microphone';
                            document.getElementById('microphone').disabled = false;
                        }, (err) => {
                            console.log("Failed to stop continuous recognition:", err);
                            document.getElementById('microphone').disabled = false;
                        });

                    handleUserQuery(userQuery, "", "");
                }
            };

            speechRecognizer.startContinuousRecognitionAsync(
                () => {
                    document.getElementById('microphone').innerHTML = 'Stop Microphone';
                    document.getElementById('microphone').disabled = false;
                }, (err) => {
                    console.log("Failed to start continuous recognition:", err);
                    document.getElementById('microphone').disabled = false;
                });
        };

        function getCurrentTime() {
            const now = new Date();
            return now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function addMessage(content, type = 'avatar') {
            const chatHistory = document.getElementById('chatHistory');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            const time = getCurrentTime();
            messageDiv.innerHTML = `
                <div>${content}</div>
                <div class="message-time">${time}</div>
            `;
            
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
            messageCount++;
        }

        function showTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            indicator.style.display = 'block';
            indicator.scrollIntoView({ behavior: 'smooth' });
        }

        function hideTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'none';
        }

        function sendMessage() {
            const input = document.getElementById('userMessage');
            const message = input.value.trim();
            
            if (message) {
                // Clear input
                input.value = '';
                
                // Handle user query with real AI
                handleUserQuery(message, "", "");
            }
        }

        function insertSuggestion(text) {
            const input = document.getElementById('userMessage');
            input.value = text;
            input.focus();
        }

        function clearChatHistory() {
            const chatHistory = document.getElementById('chatHistory');
            chatHistory.innerHTML = `
                <div class="message avatar">
                    <div>Chat history cleared. How can I help you?</div>
                    <div class="message-time">Just now</div>
                </div>
            `;
            messageCount = 1;
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            const input = document.getElementById('userMessage');
            const sendBtn = document.getElementById('sendBtn');
            
            // Start loading simulation
            simulateLoading();
            
            // Enter key to send message
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        });

        // Auto-scroll to bottom when new messages are added
        const chatHistory = document.getElementById('chatHistory');
        const observer = new MutationObserver(() => {
            chatHistory.scrollTop = chatHistory.scrollHeight;
        });
        
        observer.observe(chatHistory, { childList: true, subtree: true });
    </script>
</body>
</html>
